<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.elextec.persist.dao.mybatis.BizVehicleMapperExt">
    <resultMap extends="BaseResultMap" id="BizVehicleExtResultMap" type="com.elextec.lease.model.BizVehicleBatteryParts">
        <result column="mfrs_name" jdbcType="VARCHAR" property="mfrsName" />
    </resultMap>
    <select id="getVehicleInfoByUserId" parameterType="java.lang.String" resultMap="BizVehicleExtResultMap">
        select
        v.id vehicleId,
        v.vehicle_code,
        v.vehicle_pn,
        v.vehicle_brand,
        v.vehicle_made_in,
        v.vehicle_status,
        v.create_user,
        v.create_time,
        v.update_user,
        v.update_time,
        m.mfrs_name mfrs_name
        from biz_ref_user_vehicle r
        LEFT JOIN biz_vehicle v ON r.vehicle_id = v.id
        LEFT JOIN biz_manufacturer m ON v.mfrs_id = m.id
        where r.user_id = #{id,jdbcType=VARCHAR} AND r.unbind_time is NULL
    </select>

    <select id="getVehicleInfoById" parameterType="java.util.Map" resultType="java.util.Map">
        select
        v.id vehicleId,
        v.vehicle_code,
        v.vehicle_pn,
        v.vehicle_brand,
        v.vehicle_made_in,
        v.mfrs_id vehicleMfrsId,
        v.vehicle_status,
        v.create_user,
        v.create_time,
        v.update_user,
        v.update_time,
        m1.mfrs_name vehicleMfrsName,
        b.id batteryId,
        b.battery_code,
        b.battery_name,
        b.battery_brand,
        b.battery_pn,
        b.battery_parameters,
        b.mfrs_id batteryMfrsId,
        m2.mfrs_name batteryMfrsName,
        b.battery_status
        from biz_vehicle v
        LEFT JOIN biz_manufacturer m1 ON v.mfrs_id = m1.id
        LEFT JOIN biz_ref_vehicle_battery r ON v.id = r.vehicle_id
        <if test="flag" >
            and r.unbind_time is NULL
        </if>
        LEFT JOIN biz_battery b ON r.battery_id = b.id
        LEFT JOIN biz_manufacturer m2 ON b.mfrs_id = m2.id
        where v.id = #{id,jdbcType=VARCHAR}

    </select>

    <select id="selectExtByParam" resultMap="BizVehicleExtResultMap" parameterType="com.elextec.lease.manager.request.BizVehicleParam" >
        SELECT distinct
        a.id id,
        a.vehicle_code vehicle_code,
        a.vehicle_pn vehicle_pn,
        a.vehicle_brand vehicle_brand,
        a.vehicle_made_in vehicle_made_in,
        a.mfrs_id mfrs_id,
        a.vehicle_status vehicle_status,
        a.create_user create_user,
        a.create_time create_time,
        a.update_user update_user,
        a.update_time update_time,
        b.mfrs_name mfrs_name
        FROM
        biz_vehicle a
        LEFT JOIN biz_manufacturer b ON a.mfrs_id=b.id
        LEFT JOIN biz_ref_user_vehicle r ON a.id = r.vehicle_id
        LEFT JOIN sys_user s ON r.user_id = s.id
        <where>
            1=1
            <if test="keyStr != null and keyStr != ''" >
                and (a.vehicle_code like concat('%', #{keyStr,jdbcType=VARCHAR} ,'%')
                or a.vehicle_pn like concat('%', #{keyStr,jdbcType=VARCHAR} ,'%')
                or a.vehicle_brand like concat('%', #{keyStr,jdbcType=VARCHAR} ,'%')
                or a.vehicle_made_in like concat('%', #{keyStr,jdbcType=VARCHAR} ,'%')
                or a.mfrs_id like concat('%', #{keyStr,jdbcType=VARCHAR} ,'%')
                or b.mfrs_name like concat('%', #{keyStr,jdbcType=VARCHAR} ,'%'))
            </if>
            <if test="vehicleStatus != null and vehicleStatus != ''" >
                and a.vehicle_status = #{vehicleStatus,jdbcType=VARCHAR}
            </if>
            <if test="userId != null and userId != ''" >
                and s.id = #{userId,jdbcType=VARCHAR}
            </if>
            <if test="orgId != null and orgId != ''" >
                and s.org_id = #{orgId,jdbcType=VARCHAR}
            </if>

        </where>
        limit #{pageBegin} , #{pageSize}
    </select>

    <select id="countExtByParam" resultType="java.lang.Integer" parameterType="com.elextec.lease.manager.request.BizVehicleParam" >
        SELECT count(distinct a.id)
        FROM
        sys_user a
        LEFT JOIN biz_organization b ON a.org_id=b.id
        LEFT JOIN biz_ref_user_vehicle r ON a.id = r.vehicle_id
        LEFT JOIN sys_user s ON r.user_id = s.id
        <where>
            1=1
            <if test="keyStr != null and keyStr != ''" >
                and (a.vehicle_code like concat('%', #{keyStr,jdbcType=VARCHAR} ,'%')
                or a.vehicle_pn like concat('%', #{keyStr,jdbcType=VARCHAR} ,'%')
                or a.vehicle_brand like concat('%', #{keyStr,jdbcType=VARCHAR} ,'%')
                or a.vehicle_made_in like concat('%', #{keyStr,jdbcType=VARCHAR} ,'%')
                or a.mfrs_id like concat('%', #{keyStr,jdbcType=VARCHAR} ,'%')
                or b.mfrs_name like concat('%', #{keyStr,jdbcType=VARCHAR} ,'%'))
            </if>
            <if test="vehicleStatus != null and vehicleStatus != ''" >
                and a.vehicle_status = #{vehicleStatus,jdbcType=VARCHAR}
            </if>
            <if test="userId != null and userId != ''" >
                and s.id = #{userId,jdbcType=VARCHAR}
            </if>
            <if test="orgId != null and orgId != ''" >
                and s.org_id = #{orgId,jdbcType=VARCHAR}
            </if>
        </where>
    </select>
</mapper>